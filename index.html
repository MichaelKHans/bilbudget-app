<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamisk Bilbudget Beregner (Online)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root">
        <div class="flex items-center justify-center h-screen">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // === INDSÆT DIN FIREBASE KONFIGURATION HER ===
        const firebaseConfig = {
         apiKey: "AIzaSyAluqHT_mF5ez2qSuqOa82YIXWM2ftdbNw",
         authDomain: "bil-budget-app.firebaseapp.com",
         projectId: "bil-budget-app",
         storageBucket: "bil-budget-app.firebasestorage.app",
         messagingSenderId: "1045464125884",
         appId: "1:1045464125884:web:9e2847723fa2d59fc05bb9"
        };
        // ============================================

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            window.firebase = {
                doc, setDoc, onSnapshot, collection, query, deleteDoc,
                signInAnonymously, onAuthStateChanged
            };
            document.dispatchEvent(new Event('firebaseReady'));
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('root').innerHTML = '<div class="text-center p-8 text-red-600">Kunne ikke initialisere databasen. Tjek din Firebase-konfiguration.</div>';
        }
    </script>
    
    <script type="text/babel" data-presets="react">
        const { useState, useEffect } = React;

        const formatCurrency = (value) => {
          if (isNaN(value) || value === null) return 'N/A';
          return new Intl.NumberFormat('da-DK', { style: 'currency', currency: 'DKK', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
        };

        const initialCars = [
            { id: 12, type: 'Køb', drivmiddel: 'El', name: 'Ny Megane (Ejner Hessel)', pris: 274990, laaneTid: 96, finansieringYdelse: 2744, udbetaling: 54998, service: 400, forsikring: 650, gronAfgiftHalvaar: 420, daekPrisTotal: 6000, daekLevetidMdr: 48, vaerditabProcent: 90, uforudseteReparationer: 350, synsPris: 500, isFavorite: false },
            { id: 11, type: 'Leasing', drivmiddel: 'Benzin', name: 'Nuværende: Renault Captur', nypris: 199820, udbetaling: 0, leasingYdelse: 3301, leasingPeriode: 36, service: 0, forsikring: 0, gronAfgiftHalvaar: 640, daekPrisTotal: 5000, daekLevetidMdr: 48, uforudseteReparationer: 0, kmPerLiter: 18, isFavorite: false },
        ];

        function App() {
          const [parameters, setParameters] = useState({ periode: 48, opladningsAbonnement: 899, kmPerAar: 25000, benzinPris: 14.5 });
          const [cars, setCars] = useState([]);
          const [newCar, setNewCar] = useState({ type: 'Leasing', drivmiddel: 'El', name: '', udbetaling: 0, leasingYdelse: 4000, leasingPeriode: 36, nypris: 300000, service: 0, forsikring: 650, gronAfgiftHalvaar: 420, daekPrisTotal: 0, daekLevetidMdr: 48, uforudseteReparationer: 0, pris: 250000, laaneTid: 96, vaerditabProcent: 90, finansieringYdelse: 2500, synsPris: 500, kmPerLiter: 20, isFavorite: false });
          const [errorModalVisible, setErrorModalVisible] = useState(false);
          const [confirmModalState, setConfirmModalState] = useState({ isOpen: false, carId: null, carName: '' });
          const [saveMessage, setSaveMessage] = useState('');
          const [saveName, setSaveName] = useState('');
          const [savedScenarios, setSavedScenarios] = useState([]);
          const [selectedScenario, setSelectedScenario] = useState('');
          const [isKøbVisible, setIsKøbVisible] = useState(true);
          const [isLeasingVisible, setIsLeasingVisible] = useState(true);
          const [isSidebarVisible, setIsSidebarVisible] = useState(window.innerWidth >= 1024);
          const [userId, setUserId] = useState(null);
          const [isLoading, setIsLoading] = useState(true);
          const [isInitialLoadDone, setIsInitialLoadDone] = useState(false);

          useEffect(() => {
              const { auth, onAuthStateChanged, signInAnonymously } = window.firebase;
              const unsubscribe = onAuthStateChanged(auth, (user) => {
                  if (user) {
                      setUserId(user.uid);
                  } else {
                      signInAnonymously(auth).catch((error) => console.error("Anonymous sign-in failed:", error));
                  }
              });
              return () => unsubscribe();
          }, []);

          useEffect(() => {
              if (!userId) return;
              const { db, collection, query, onSnapshot } = window.firebase;
              const scenariosCollection = collection(db, 'users', userId, 'scenarios');
              const unsubscribe = onSnapshot(query(scenariosCollection), (snapshot) => {
                  const scenariosData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  setSavedScenarios(scenariosData);
                  if (!isInitialLoadDone) {
                      if (snapshot.empty) {
                          setCars(initialCars);
                      } else {
                          const firstScenario = scenariosData[0];
                          setCars(firstScenario.cars.map(c => ({...c, isFavorite: c.isFavorite || false})));
                          setParameters(firstScenario.parameters);
                          setSelectedScenario(firstScenario.id);
                      }
                      setIsInitialLoadDone(true);
                      setIsLoading(false);
                  }
              }, (error) => {
                  console.error("Error fetching scenarios:", error);
                  setIsLoading(false);
              });
              return () => unsubscribe();
          }, [userId, isInitialLoadDone]);
          
          const showSaveMessage = (msg) => {
            setSaveMessage(msg);
            setTimeout(() => setSaveMessage(''), 2500);
          };

          const saveData = async () => {
              if (!saveName || !userId) {
                  showSaveMessage('Indtast et navn for at gemme.');
                  return;
              }
              const { db, doc, setDoc } = window.firebase;
              try {
                  const scenarioRef = doc(db, 'users', userId, 'scenarios', saveName);
                  await setDoc(scenarioRef, { cars, parameters });
                  showSaveMessage(`'${saveName}' er gemt online!`);
                  setSelectedScenario(saveName);
              } catch (error) {
                  console.error("Error saving document: ", error);
                  showSaveMessage('Fejl: Kunne ikke gemme online.');
              }
          };

          const loadData = (scenarioId) => {
              if (!scenarioId) return;
              const dataToLoad = savedScenarios.find(s => s.id === scenarioId);
              if (dataToLoad) {
                  setCars(dataToLoad.cars.map(c => ({...c, isFavorite: c.isFavorite || false})));
                  setParameters(dataToLoad.parameters);
                  showSaveMessage(`'${scenarioId}' er hentet!`);
              }
          };

          const deleteData = async () => {
              if (!selectedScenario || !userId) {
                  showSaveMessage('Vælg et scenarie at slette.');
                  return;
              }
              if (confirm(`Er du sikker på, at du vil slette '${selectedScenario}'? Dette kan ikke fortrydes.`)) {
                  const { db, doc, deleteDoc } = window.firebase;
                  try {
                      const scenarioRef = doc(db, 'users', userId, 'scenarios', selectedScenario);
                      await deleteDoc(scenarioRef);
                      showSaveMessage(`'${selectedScenario}' er slettet.`);
                      setSelectedScenario('');
                      if(savedScenarios.length <= 1) {
                        setCars(initialCars);
                        setParameters({ periode: 48, opladningsAbonnement: 899, kmPerAar: 25000, benzinPris: 14.5 });
                      }
                  } catch (error) {
                      console.error("Error deleting document: ", error);
                      showSaveMessage('Fejl: Kunne ikke slette.');
                  }
              }
          };
          
          const handleCarChange = (id, field, value) => {
            setCars(prevCars =>
              prevCars.map(car =>
                car.id === id ? { ...car, [field]: value === '' ? '' : (field === 'name' ? value : parseFloat(value) || 0) } : car
              )
            );
          };
          
          const handleNewCarChange = (e) => {
            const { name, value, type } = e.target;
            let parsedValue = value;
             if (type === 'number') {
                 parsedValue = parseFloat(value) || 0;
            }
            const updatedCar = { ...newCar, [name]: parsedValue };
            
            if (name === 'drivmiddel') {
                updatedCar.gronAfgiftHalvaar = value === 'Benzin' ? 640 : 370;
            }
            if (name === 'type') {
                updatedCar.uforudseteReparationer = value === 'Køb' ? 350 : 0;
            }
            setNewCar(updatedCar);
          };

          const addCar = () => {
            if (!newCar.name) {
              setErrorModalVisible(true);
              return;
            }
            const newCarData = { ...newCar, id: Date.now() };
            setCars(prev => [...prev, newCarData]);
            setNewCar({ type: 'Leasing', drivmiddel: 'El', name: '', udbetaling: 0, leasingYdelse: 4000, leasingPeriode: 36, nypris: 300000, service: 0, forsikring: 650, gronAfgiftHalvaar: 370, daekPrisTotal: 0, daekLevetidMdr: 48, uforudseteReparationer: 0, pris: 250000, laaneTid: 96, vaerditabProcent: 90, finansieringYdelse: 2500, synsPris: 500, kmPerLiter: 20, isFavorite: false });
          };

          const openRemoveModal = (id, name) => setConfirmModalState({ isOpen: true, carId: id, carName: name });
          const closeRemoveModal = () => setConfirmModalState({ isOpen: false, carId: null, carName: '' });

          const handleConfirmRemove = () => {
            if (confirmModalState.carId !== null) {
              setCars(prev => prev.filter(car => car.id !== confirmModalState.carId));
            }
            closeRemoveModal();
          };
          
          const handleToggleFavorite = (id) => setCars(prevCars => prevCars.map(car => car.id === id ? {...car, isFavorite: !car.isFavorite} : car));
          
          const handleDuplicateCar = (id) => {
              const carToCopy = cars.find(car => car.id === id);
              if (!carToCopy) return;
              const match = carToCopy.name.match(/^(.*?)(\s(\d+))?$/);
              let baseName = carToCopy.name;
              let newNumber = 2;
              if (match) {
                  baseName = match[1];
                  if (match[3]) newNumber = parseInt(match[3], 10) + 1;
              }
              const newName = `${baseName} ${newNumber}`;
              const newCar = { ...carToCopy, id: Date.now(), name: newName, isFavorite: false };
              const originalIndex = cars.findIndex(car => car.id === id);
              const newCars = [...cars];
              newCars.splice(originalIndex + 1, 0, newCar);
              setCars(newCars);
          };

          const handleMoveCar = (id, direction) => {
              const carToMove = cars.find(c => c.id === id);
              if (!carToMove) return;
              const carTypeGroup = cars.filter(c => c.type === carToMove.type);
              const currentIndexInGroup = carTypeGroup.findIndex(c => c.id === id);
              let targetIndexInGroup;
              if (direction === 'left' && currentIndexInGroup > 0) targetIndexInGroup = currentIndexInGroup - 1;
              else if (direction === 'right' && currentIndexInGroup < carTypeGroup.length - 1) targetIndexInGroup = currentIndexInGroup + 1;
              else return; 
              const targetCar = carTypeGroup[targetIndexInGroup];
              const newCars = [...cars];
              const index1 = newCars.findIndex(c => c.id === carToMove.id);
              const index2 = newCars.findIndex(c => c.id === targetCar.id);
              [newCars[index1], newCars[index2]] = [newCars[index2], newCars[index1]];
              setCars(newCars);
          };

          const kobeBiler = cars.filter(car => car.type === 'Køb');
          const leasingBiler = cars.filter(car => car.type === 'Leasing');

          const renderCarColumn = (car, index, group) => {
            const gronAfgiftMonthly = (car.gronAfgiftHalvaar || 0) / 6;
            const daekMonthly = (car.daekPrisTotal || 0) / (car.daekLevetidMdr || 1);
            const synMonthly = car.type === 'Køb' ? (car.synsPris || 0) / 24 : 0;
            let drivmiddelMonthly = 0;
            if (car.drivmiddel === 'El') drivmiddelMonthly = parameters.opladningsAbonnement || 0;
            else if (car.drivmiddel === 'Benzin' && car.kmPerLiter > 0) {
                const kmPerMonth = (parameters.kmPerAar || 0) / 12;
                drivmiddelMonthly = (kmPerMonth / car.kmPerLiter) * (parameters.benzinPris || 0);
            }
            const kerneYdelse = car.type === 'Køb' ? car.finansieringYdelse : car.leasingYdelse;
            const driftsudgifter = (car.forsikring || 0) + (car.service || 0) + gronAfgiftMonthly + daekMonthly + (car.uforudseteReparationer || 0) + synMonthly + drivmiddelMonthly;
            const totalPerMaaned = kerneYdelse + driftsudgifter;
            const samletUdgiftTotal = (totalPerMaaned * parameters.periode) + car.udbetaling;
            const favoriteClass = car.isFavorite ? 'bg-green-50 border-green-300' : 'bg-white';
            const drivmiddelColorClass = car.drivmiddel === 'El' ? 'bg-blue-50' : 'bg-orange-50';
            const totalFinancingCost = car.type === 'Køb' ? (car.finansieringYdelse * (car.laaneTid || 0)) + (car.udbetaling || 0) : 0;
            const samletBetalingBil = (kerneYdelse * parameters.periode) + car.udbetaling;

            return (
              <div key={car.id} className={`border rounded-lg shadow-md p-3 relative flex flex-col ${favoriteClass}`}>
                <div className="mb-2">
                    <input type="text" value={car.name} onChange={(e) => handleCarChange(car.id, 'name', e.target.value)} className={`font-bold text-sm p-1 rounded-md border border-gray-300 w-full ${drivmiddelColorClass}`} />
                </div>
                <div className="flex justify-between items-center mb-2">
                    <div className="flex items-center space-x-2">
                        <span className={`text-xs font-bold px-2 py-1 rounded-full ${car.drivmiddel === 'El' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}`}>{car.drivmiddel}</span>
                        <button onClick={() => handleMoveCar(car.id, 'left')} disabled={index === 0} className="p-1 disabled:opacity-25 text-gray-500 hover:text-gray-800"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg></button>
                        <button onClick={() => handleMoveCar(car.id, 'right')} disabled={index === group.length - 1} className="p-1 disabled:opacity-25 text-gray-500 hover:text-gray-800"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg></button>
                    </div>
                    <div className="flex items-center">
                      <button onClick={() => handleToggleFavorite(car.id)} className="p-1 text-gray-400 hover:text-yellow-500"><svg className={`w-5 h-5 ${car.isFavorite ? 'text-yellow-400' : ''}`} fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg></button>
                      <button onClick={() => handleDuplicateCar(car.id)} className="p-1 text-gray-400 hover:text-blue-500"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>
                      <button onClick={() => openRemoveModal(car.id, car.name)} className="p-1 text-red-400 hover:text-red-600"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                    </div>
                </div>
                {/* ... Resten af JSX for bilkortet ... */}
              </div>
            );
          };
          
          const LongTermSummary = () => {
              // ... (LongTermSummary komponentens logik) ...
              return <div>...</div>
          };
          
          if (isLoading) {
              return <div className="flex items-center justify-center h-screen"><div className="spinner"></div></div>;
          }

          return (
            <div className="font-sans">
                {/* ... (Hele App'ens JSX-struktur, inklusiv header, sidebar og bilkort-sektioner) ... */}
            </div>
          );
        }
        
        document.addEventListener('firebaseReady', () => {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        });
    </script>
</body>
</html>