<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamisk Bilbudget Beregner (Online)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
        /* Tilføjer en lille animation til loading-indikatoren */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root">
        <!-- Viser en loading-indikator mens Firebase indlæses -->
        <div class="flex items-center justify-center h-screen">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Firebase SDK - Tilføjet for online database funktionalitet -->
    <script type="module">
        // Importer de nødvendige Firebase-funktioner
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // =================================================================================
        // === VIGTIGT: INDSÆT DIN FIREBASE KONFIGURATION HER ===============================
        // =================================================================================
        const firebaseConfig = {
            apiKey: "DIN_API_KEY",
            authDomain: "DIT_PROJEKT_ID.firebaseapp.com",
            projectId: "DIT_PROJEKT_ID",
            storageBucket: "DIT_PROJEKT_ID.appspot.com",
            messagingSenderId: "DIN_MESSAGING_SENDER_ID",
            appId: "DIN_APP_ID"
        };
        // =================================================================================

        try {
            // Initialiser Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            // Gør Firebase-funktionerne tilgængelige globalt for React-komponenten
            window.db = db;
            window.auth = auth;
            window.firebase = {
                doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, getDocs,
                signInAnonymously, onAuthStateChanged
            };

            // Opret et custom event for at signalere, at Firebase er klar
            const event = new Event('firebaseReady');
            document.dispatchEvent(event);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('root').innerHTML = '<div class="text-center p-8 text-red-600">Kunne ikke initialisere databasen. Tjek venligst din Firebase-konfiguration i koden.</div>';
        }
    </script>
    
    <script type="text/babel" data-presets="react,stage-3">
        // Helper function to format numbers as Danish currency (DKK)
        const formatCurrency = (value) => {
          if (isNaN(value) || value === null) return 'N/A';
          return new Intl.NumberFormat('da-DK', {
            style: 'currency',
            currency: 'DKK',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          }).format(value);
        };

        // Initial state for the cars
        const initialCars = [
            { id: 12, type: 'Køb', drivmiddel: 'El', name: 'Ny Megane (Ejner Hessel)', pris: 274990, laaneTid: 96, finansieringYdelse: 2744, udbetaling: 54998, service: 400, forsikring: 650, gronAfgiftHalvaar: 420, daekPrisTotal: 6000, daekLevetidMdr: 48, vaerditabProcent: 90, uforudseteReparationer: 350, synsPris: 500, isFavorite: false },
            { id: 11, type: 'Leasing', drivmiddel: 'Benzin', name: 'Nuværende: Renault Captur', nypris: 199820, udbetaling: 0, leasingYdelse: 3301, leasingPeriode: 36, service: 0, forsikring: 0, gronAfgiftHalvaar: 640, daekPrisTotal: 5000, daekLevetidMdr: 48, uforudseteReparationer: 0, kmPerLiter: 18, isFavorite: false },
        ];

        // Main App Component
        function App() {
          const [parameters, setParameters] = React.useState({
            periode: 48,
            opladningsAbonnement: 899,
            kmPerAar: 25000,
            benzinPris: 14.5,
          });

          const [cars, setCars] = React.useState([]);
          const [newCar, setNewCar] = React.useState({ 
              type: 'Leasing', drivmiddel: 'El', name: '', udbetaling: 0, leasingYdelse: 4000, leasingPeriode: 36, nypris: 300000,
              service: 0, forsikring: 650, gronAfgiftHalvaar: 420, daekPrisTotal: 0, daekLevetidMdr: 48, uforudseteReparationer: 0,
              pris: 250000, laaneTid: 96, vaerditabProcent: 90, finansieringYdelse: 2500, synsPris: 500, kmPerLiter: 20, isFavorite: false
          });
          
          const [errorModalVisible, setErrorModalVisible] = React.useState(false);
          const [confirmModalState, setConfirmModalState] = React.useState({ isOpen: false, carId: null, carName: '' });
          const [saveMessage, setSaveMessage] = React.useState('');
          const [saveName, setSaveName] = React.useState('');
          const [savedScenarios, setSavedScenarios] = React.useState([]);
          const [selectedScenario, setSelectedScenario] = React.useState('');
          const [isKøbVisible, setIsKøbVisible] = React.useState(true);
          const [isLeasingVisible, setIsLeasingVisible] = React.useState(true);
          const [isSidebarVisible, setIsSidebarVisible] = React.useState(window.innerWidth >= 1024);
          const [userId, setUserId] = React.useState(null);
          const [isLoading, setIsLoading] = React.useState(true);

          // Effect for Firebase Authentication
          React.useEffect(() => {
              const { auth, onAuthStateChanged, signInAnonymously } = window.firebase;
              const unsubscribe = onAuthStateChanged(auth, (user) => {
                  if (user) {
                      setUserId(user.uid);
                  } else {
                      signInAnonymously(auth).catch((error) => {
                          console.error("Anonymous sign-in failed:", error);
                          setIsLoading(false);
                      });
                  }
              });
              return () => unsubscribe();
          }, []);

          // Effect for loading data from Firestore
          React.useEffect(() => {
              if (!userId) return;

              const { db, collection, query, onSnapshot } = window.firebase;
              const scenariosCollection = collection(db, 'users', userId, 'scenarios');
              
              const unsubscribe = onSnapshot(query(scenariosCollection), (snapshot) => {
                  const scenariosData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  setSavedScenarios(scenariosData);
                  
                  if (snapshot.empty && cars.length === 0) {
                      setCars(initialCars);
                  } else if (cars.length === 0 && !snapshot.empty) {
                      const firstScenario = scenariosData[0];
                      setCars(firstScenario.cars.map(c => ({...c, isFavorite: c.isFavorite || false})));
                      setParameters(firstScenario.parameters);
                      setSelectedScenario(firstScenario.id);
                  }
                  setIsLoading(false);
              }, (error) => {
                  console.error("Error fetching scenarios:", error);
                  setIsLoading(false);
              });

              return () => unsubscribe();
          }, [userId]);
          
          const showSaveMessage = (msg) => {
            setSaveMessage(msg);
            setTimeout(() => setSaveMessage(''), 2500);
          };

          const saveData = async () => {
              if (!saveName || !userId) {
                  showSaveMessage('Indtast et navn for at gemme.');
                  return;
              }
              const { db, doc, setDoc } = window.firebase;
              try {
                  const scenarioRef = doc(db, 'users', userId, 'scenarios', saveName);
                  await setDoc(scenarioRef, { cars, parameters });
                  showSaveMessage(`'${saveName}' er gemt online!`);
                  setSelectedScenario(saveName);
              } catch (error) {
                  console.error("Error saving document: ", error);
                  showSaveMessage('Fejl: Kunne ikke gemme online.');
              }
          };

          const loadData = () => {
              if (!selectedScenario) {
                  showSaveMessage('Vælg et scenarie at hente.');
                  return;
              }
              const dataToLoad = savedScenarios.find(s => s.id === selectedScenario);
              if (dataToLoad) {
                  setCars(dataToLoad.cars.map(c => ({...c, isFavorite: c.isFavorite || false})));
                  setParameters(dataToLoad.parameters);
                  showSaveMessage(`'${selectedScenario}' er hentet!`);
              }
          };

          const deleteData = async () => {
              if (!selectedScenario || !userId) {
                  showSaveMessage('Vælg et scenarie at slette.');
                  return;
              }
              if (confirm(`Er du sikker på, at du vil slette '${selectedScenario}'? Dette kan ikke fortrydes.`)) {
                  const { db, doc, deleteDoc } = window.firebase;
                  try {
                      const scenarioRef = doc(db, 'users', userId, 'scenarios', selectedScenario);
                      await deleteDoc(scenarioRef);
                      showSaveMessage(`'${selectedScenario}' er slettet.`);
                      setSelectedScenario('');
                      if(savedScenarios.length <= 1) {
                        setCars(initialCars);
                      }
                  } catch (error) {
                      console.error("Error deleting document: ", error);
                      showSaveMessage('Fejl: Kunne ikke slette.');
                  }
              }
          };
          
          const handleCarChange = (id, field, value) => {
            setCars(prevCars =>
              prevCars.map(car =>
                car.id === id ? { ...car, [field]: value === '' ? '' : (field === 'name' ? value : parseFloat(value) || 0) } : car
              )
            );
          };
          
          const handleNewCarChange = (e) => {
            const { name, value, type } = e.target;
            let parsedValue = value;
             if (type === 'number') {
                 parsedValue = parseFloat(value) || 0;
            }
            const updatedCar = { ...newCar, [name]: parsedValue };
            
            if (name === 'drivmiddel') {
                updatedCar.gronAfgiftHalvaar = value === 'Benzin' ? 640 : 370;
            }
            if (name === 'type') {
                updatedCar.uforudseteReparationer = value === 'Køb' ? 350 : 0;
            }
            setNewCar(updatedCar);
          };

          const addCar = () => {
            if (!newCar.name) {
              setErrorModalVisible(true);
              return;
            }
            const newCarData = {
                ...newCar,
                id: Date.now(), // Use timestamp for unique ID
            };
            setCars(prev => [...prev, newCarData]);
            setNewCar({ type: 'Leasing', drivmiddel: 'El', name: '', udbetaling: 0, leasingYdelse: 4000, leasingPeriode: 36, nypris: 300000, service: 0, forsikring: 650, gronAfgiftHalvaar: 370, daekPrisTotal: 0, daekLevetidMdr: 48, uforudseteReparationer: 0, pris: 250000, laaneTid: 96, vaerditabProcent: 90, finansieringYdelse: 2500, synsPris: 500, kmPerLiter: 20, isFavorite: false });
          };

          const openRemoveModal = (id, name) => {
            setConfirmModalState({ isOpen: true, carId: id, carName: name });
          };
          
          const closeRemoveModal = () => {
            setConfirmModalState({ isOpen: false, carId: null, carName: '' });
          };

          const handleConfirmRemove = () => {
            if (confirmModalState.carId !== null) {
              setCars(prev => prev.filter(car => car.id !== confirmModalState.carId));
            }
            closeRemoveModal();
          };
          
          const handleToggleFavorite = (id) => {
              setCars(prevCars => prevCars.map(car => car.id === id ? {...car, isFavorite: !car.isFavorite} : car));
          };
          
          const handleDuplicateCar = (id) => {
              const carToCopy = cars.find(car => car.id === id);
              if (!carToCopy) return;

              const match = carToCopy.name.match(/^(.*?)(\s(\d+))?$/);
              let baseName = carToCopy.name;
              let newNumber = 2;

              if (match) {
                  baseName = match[1];
                  if (match[3]) {
                      newNumber = parseInt(match[3], 10) + 1;
                  }
              }
              const newName = `${baseName} ${newNumber}`;

              const newCar = {
                  ...carToCopy,
                  id: Date.now(),
                  name: newName,
                  isFavorite: false,
              };

              const originalIndex = cars.findIndex(car => car.id === id);
              const newCars = [...cars];
              newCars.splice(originalIndex + 1, 0, newCar);
              setCars(newCars);
          };

          const handleMoveCar = (id, direction) => {
              const carToMove = cars.find(c => c.id === id);
              if (!carToMove) return;

              const carTypeGroup = cars.filter(c => c.type === carToMove.type);
              const currentIndexInGroup = carTypeGroup.findIndex(c => c.id === id);

              let targetIndexInGroup;
              if (direction === 'left' && currentIndexInGroup > 0) {
                  targetIndexInGroup = currentIndexInGroup - 1;
              } else if (direction === 'right' && currentIndexInGroup < carTypeGroup.length - 1) {
                  targetIndexInGroup = currentIndexInGroup + 1;
              } else {
                  return; 
              }

              const targetCar = carTypeGroup[targetIndexInGroup];
              
              const newCars = [...cars];
              const index1 = newCars.findIndex(c => c.id === carToMove.id);
              const index2 = newCars.findIndex(c => c.id === targetCar.id);
              
              [newCars[index1], newCars[index2]] = [newCars[index2], newCars[index1]];
              
              setCars(newCars);
          };


          const kobeBiler = cars.filter(car => car.type === 'Køb');
          const leasingBiler = cars.filter(car => car.type === 'Leasing');

          const renderCarColumn = (car, index, group) => {
            const gronAfgiftMonthly = (car.gronAfgiftHalvaar || 0) / 6;
            const daekMonthly = (car.daekPrisTotal || 0) / (car.daekLevetidMdr || 1);
            const synMonthly = car.type === 'Køb' ? (car.synsPris || 0) / 24 : 0;
            
            let drivmiddelMonthly = 0;
            if (car.drivmiddel === 'El') {
                drivmiddelMonthly = parameters.opladningsAbonnement || 0;
            } else if (car.drivmiddel === 'Benzin' && car.kmPerLiter > 0) {
                const kmPerMonth = (parameters.kmPerAar || 0) / 12;
                drivmiddelMonthly = (kmPerMonth / car.kmPerLiter) * (parameters.benzinPris || 0);
            }

            const totalFinancingCost = car.type === 'Køb' ? (car.finansieringYdelse * (car.laaneTid || 0)) + (car.udbetaling || 0) : 0;
            const kerneYdelse = car.type === 'Køb' ? car.finansieringYdelse : car.leasingYdelse;
            const samletBetalingBil = (kerneYdelse * parameters.periode) + car.udbetaling;
            const driftsudgifter = (car.forsikring || 0) + (car.service || 0) + gronAfgiftMonthly + daekMonthly + (car.uforudseteReparationer || 0) + synMonthly + drivmiddelMonthly;
            const totalPerMaaned = kerneYdelse + driftsudgifter;
            const samletUdgiftTotal = (totalPerMaaned * parameters.periode) + car.udbetaling;
            
            const favoriteClass = car.isFavorite ? 'bg-green-50 border-green-300' : 'bg-white';
            const drivmiddelColorClass = car.drivmiddel === 'El' ? 'bg-blue-50' : 'bg-orange-50';

            const LeasingDealIndicator = ({ car }) => {
                if (car.type !== 'Leasing' || !car.nypris || car.nypris === 0) return null;
                
                let adjustedLeasingYdelse = car.leasingYdelse || 0;
                if (car.forsikring === 0) {
                    const defaultInsuranceValue = 650; 
                    adjustedLeasingYdelse = Math.max(0, adjustedLeasingYdelse - defaultInsuranceValue);
                }
                
                const totalAdjustedLeasingCost = (adjustedLeasingYdelse * car.leasingPeriode) + car.udbetaling;
                const percentage = (totalAdjustedLeasingCost / car.nypris) * 100;

                let text, color;
                if (percentage <= 50) {
                    text = "Godt tilbud";
                    color = "text-green-600";
                } else if (percentage <= 60) {
                    text = "Overvej";
                    color = "text-orange-500";
                } else {
                    text = "Anbefales ikke";
                    color = "text-red-600";
                }

                return (
                    <div className="mt-2 text-center">
                        <p className={`text-sm font-bold ${color}`}>{text}</p>
                        <p className="text-xs text-gray-500">
                            Ren bilomk. er {percentage.toFixed(1)}% af nypris
                        </p>
                    </div>
                );
            };

            return (
              <div key={car.id} className={`border rounded-lg shadow-md p-3 relative flex flex-col ${favoriteClass}`}>
                <div className="mb-2">
                    <input type="text" value={car.name} onChange={(e) => handleCarChange(car.id, 'name', e.target.value)} className={`font-bold text-sm p-1 rounded-md border border-gray-300 w-full ${drivmiddelColorClass}`} />
                </div>
                <div className="flex justify-between items-center mb-2">
                    <div className="flex items-center space-x-2">
                        <span className={`text-xs font-bold px-2 py-1 rounded-full ${car.drivmiddel === 'El' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}`}>
                            {car.drivmiddel}
                        </span>
                        <button onClick={() => handleMoveCar(car.id, 'left')} disabled={index === 0} className="p-1 disabled:opacity-25 text-gray-500 hover:text-gray-800">
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>
                        </button>
                        <button onClick={() => handleMoveCar(car.id, 'right')} disabled={index === group.length - 1} className="p-1 disabled:opacity-25 text-gray-500 hover:text-gray-800">
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                        </button>
                    </div>
                    <div className="flex items-center">
                      <button onClick={() => handleToggleFavorite(car.id)} className="p-1 text-gray-400 hover:text-yellow-500">
                        <svg className={`w-5 h-5 ${car.isFavorite ? 'text-yellow-400' : ''}`} fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                      </button>
                      <button onClick={() => handleDuplicateCar(car.id)} className="p-1 text-gray-400 hover:text-blue-500">
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                      </button>
                      <button onClick={() => openRemoveModal(car.id, car.name)} className="p-1 text-red-400 hover:text-red-600">
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                      </button>
                    </div>
                </div>
                
                <div className="mb-4">
                    <h4 className="font-semibold text-xs text-gray-500 mb-1">Engangsudgifter</h4>
                    <div className="flex justify-between items-center text-sm"><span>Udbetaling</span><input type="number" value={car.udbetaling} onChange={(e) => handleCarChange(car.id, 'udbetaling', e.target.value)} className="w-20 p-1 text-right rounded-md border" /></div>
                </div>
                
                {car.type === 'Køb' ? (
                    <div className="mb-4 bg-blue-50 p-2 rounded-lg">
                        <h4 className="font-semibold text-xs text-blue-800 mb-1">Finansieringsdetaljer</h4>
                        <div className="flex justify-between items-center text-sm"><span>Kontantpris</span><input type="number" value={car.pris} onChange={(e) => handleCarChange(car.id, 'pris', e.target.value)} className="w-20 p-1 text-right rounded-md border" /></div>
                        <div className="flex justify-between items-center text-sm"><span>Løbetid (mdr.)</span><input type="number" value={car.laaneTid} onChange={(e) => handleCarChange(car.id, 'laaneTid', e.target.value)} className="w-20 p-1 text-right rounded-md border" /></div>
                        <div className="flex justify-between items-center text-sm mt-1"><span>Værditab 8 år (%)</span><input type="number" value={car.vaerditabProcent} onChange={(e) => handleCarChange(car.id, 'vaerditabProcent', e.target.value)} className="w-20 p-1 text-right rounded-md border" /></div>
                        <div className="flex justify-between items-center text-sm mt-2 pt-2 border-t border-blue-200"><span className="font-bold text-blue-800">Samlet tilbagebetaling</span><span className="font-bold text-blue-800">{formatCurrency(totalFinancingCost)}</span></div>
                    </div>
                ) : (
                     <div className="mb-4 bg-green-50 p-2 rounded-lg">
                        <h4 className="font-semibold text-xs text-green-800 mb-1">Leasing Detaljer</h4>
                        <div className="flex justify-between items-center text-sm"><span>Nypris</span><input type="number" value={car.nypris} onChange={(e) => handleCarChange(car.id, 'nypris', e.target.value)} className="w-20 p-1 text-right rounded-md border" /></div>
                        <div className="flex justify-between items-center text-sm"><span>Leasingperiode (mdr.)</span><input type="number" value={car.leasingPeriode} onChange={(e) => handleCarChange(car.id, 'leasingPeriode', e.target.value)} className="w-20 p-1 text-right rounded-md border" /></div>
                        <LeasingDealIndicator car={car} />
                    </div>
                )}

                <div className="mb-4">
                    <h4 className="font-semibold text-xs text-gray-500 mb-1">Bilens Kerneydelse</h4>
                    <div className="flex justify-between items-center text-sm"><span>{car.type === 'Køb' ? 'Finansiering/md' : 'Leasingydelse/md'}</span><input type="number" value={kerneYdelse} onChange={(e) => handleCarChange(car.id, car.type === 'Køb' ? 'finansieringYdelse' : 'leasingYdelse', e.target.value)} className="w-20 p-1 text-right rounded-md border" /></div>
                    <div className="flex justify-between items-center text-sm mt-2 pt-2 border-t"><span className="font-bold">Betaling for bil ({parameters.periode} mdr.)</span><span className="font-bold">{formatCurrency(samletBetalingBil)}</span></div>
                </div>

                <div className="mb-4">
                    <h4 className="font-semibold text-xs text-gray-500 mb-1">Faste Månedlige Driftsudgifter</h4>
                    <div className="flex justify-between items-center text-sm">
                        <div className="flex items-center">
                            <span>Forsikring</span>
                            {car.forsikring === 0 && (
                                <div className="relative group ml-1">
                                    <svg className="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" /></svg>
                                    <div className="absolute bottom-full mb-2 w-48 p-2 text-xs text-white bg-black rounded-md opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                        Forsikring er 0 kr. Er den inkluderet i en anden post, f.eks. leasingydelsen?
                                    </div>
                                </div>
                            )}
                        </div>
                        <input type="number" value={car.forsikring} onChange={(e) => handleCarChange(car.id, 'forsikring', e.target.value)} className="w-20 p-1 text-right rounded-md border" />
                    </div>
                    <div className="flex justify-between items-center text-sm"><span>Serviceaftale</span><input type="number" value={car.service} onChange={(e) => handleCarChange(car.id, 'service', e.target.value)} className="w-20 p-1 text-right rounded-md border" /></div>
                    {car.type === 'Køb' && (
                        <div className="flex justify-between items-center text-sm">
                            <span>Syn (hvert 2. år)</span>
                            <div className="flex flex-col items-end">
                                <input type="number" value={car.synsPris} onChange={(e) => handleCarChange(car.id, 'synsPris', e.target.value)} className="w-20 p-1 text-right rounded-md border" />
                                <span className="text-xs text-gray-500">({formatCurrency(synMonthly)}/md)</span>
                            </div>
                        </div>
                    )}
                    {car.type === 'Køb' && <div className="flex justify-between items-center text-sm"><span>Uforudsete Rep.</span><input type="number" value={car.uforudseteReparationer} onChange={(e) => handleCarChange(car.id, 'uforudseteReparationer', e.target.value)} className="w-20 p-1 text-right rounded-md border" /></div>}
                    <div className="flex justify-between items-center text-sm"><span>Grøn afgift (halvår)</span><div className="flex flex-col items-end"><input type="number" value={car.gronAfgiftHalvaar} onChange={(e) => handleCarChange(car.id, 'gronAfgiftHalvaar', e.target.value)} className="w-20 p-1 text-right rounded-md border" /><span className="text-xs text-gray-500">({formatCurrency(gronAfgiftMonthly)}/md)</span></div></div>
                    
                    <div className="flex justify-between items-center text-sm">
                        <span>{car.drivmiddel === 'El' ? 'Opladning' : 'Benzin'}</span>
                        <span className="font-medium">{formatCurrency(drivmiddelMonthly)}</span>
                    </div>
                    {car.drivmiddel === 'Benzin' && (
                         <div className="flex justify-between items-center text-sm"><span>Km/l</span><input type="number" value={car.kmPerLiter} onChange={(e) => handleCarChange(car.id, 'kmPerLiter', e.target.value)} className="w-20 p-1 text-right rounded-md border" /></div>
                    )}

                    <div className="bg-gray-50 p-2 rounded-lg mt-2">
                        <h5 className="font-semibold text-xs text-gray-500 mb-1">Periodiske Udgifter (Dæk)</h5>
                        <div className="flex justify-between items-center text-sm"><span>Pris (4 stk.)</span><input type="number" value={car.daekPrisTotal} onChange={(e) => handleCarChange(car.id, 'daekPrisTotal', e.target.value)} className="w-20 p-1 text-right rounded-md border" /></div>
                        <div className="flex justify-between items-center text-sm"><span>Levetid (mdr.)</span><input type="number" value={car.daekLevetidMdr} onChange={(e) => handleCarChange(car.id, 'daekLevetidMdr', e.target.value)} className="w-20 p-1 text-right rounded-md border" /></div>
                         <div className="flex justify-between items-center text-sm pt-1 border-t mt-1"><span className="font-medium">Dækudgift/md</span><span className="font-medium">{formatCurrency(daekMonthly)}</span></div>
                    </div>
                    <div className="flex justify-between items-center text-sm mt-2 pt-2 border-t"><span className="font-bold">Drift i alt (md.)</span><span className="font-bold">{formatCurrency(driftsudgifter)}</span></div>
                </div>

                <div className="bg-gray-100 p-2 rounded-lg mt-auto">
                    <div className="flex justify-between items-center text-sm font-bold"><span>I ALT PR. MÅNED</span><span>{formatCurrency(totalPerMaaned)}</span></div>
                    <div className="flex justify-between items-center text-sm font-bold mt-2 pt-2 border-t"><span>SAMLET UDGIFT ({parameters.periode} mdr.)</span><span>{formatCurrency(samletUdgiftTotal)}</span></div>
                </div>
              </div>
            );
          };
          
          const LongTermSummary = () => {
              const sortedCars = [
                  ...cars.filter(car => car.type === 'Køb'),
                  ...cars.filter(car => car.type === 'Leasing')
              ];

              return (
                  <div id="print-section" className="bg-white p-4 rounded-lg shadow-md">
                      <div className="flex justify-between items-center mb-3 p-3 bg-gray-100 rounded-t-lg border-b-2 border-purple-500">
                        <h2 className="text-2xl font-bold text-gray-700">Langsigtet Sammenligning (8 år / 96 måneder)</h2>
                        <button onClick={() => window.print()} className="no-print p-2 rounded-full hover:bg-gray-200">
                           <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        </button>
                      </div>
                      <div className="overflow-x-auto">
                          <table className="min-w-full divide-y divide-gray-200">
                              <thead className="bg-purple-100">
                                  <tr>
                                      <th className="px-6 py-3 text-left text-xs font-medium text-purple-800 uppercase tracking-wider">Bil</th>
                                      <th className="px-6 py-3 text-left text-xs font-medium text-purple-800 uppercase tracking-wider">Type</th>
                                      <th className="px-6 py-3 text-left text-xs font-medium text-purple-800 uppercase tracking-wider">Drivmiddel</th>
                                      <th className="px-6 py-3 text-left text-xs font-medium text-purple-800 uppercase tracking-wider">I alt pr. måned</th>
                                      <th className="px-6 py-3 text-left text-xs font-medium text-purple-800 uppercase tracking-wider">Total Biludgift</th>
                                      <th className="px-6 py-3 text-left text-xs font-medium text-purple-800 uppercase tracking-wider">Total Drift</th>
                                      <th className="px-6 py-3 text-left text-xs font-medium text-purple-800 uppercase tracking-wider">Total Omkostning</th>
                                      <th className="px-6 py-3 text-left text-xs font-medium text-purple-800 uppercase tracking-wider">Forventet Restværdi</th>
                                      <th className="px-6 py-3 text-left text-xs font-medium text-purple-800 uppercase tracking-wider">Netto Omkostning</th>
                                  </tr>
                              </thead>
                              <tbody className="bg-white divide-y divide-gray-200">
                                  {sortedCars.map((car, index) => {
                                      const gronAfgiftMonthly = (car.gronAfgiftHalvaar || 0) / 6;
                                      const daekMonthly = (car.daekPrisTotal || 0) / (car.daekLevetidMdr || 1);
                                      const synMonthly = car.type === 'Køb' ? (car.synsPris || 0) / 24 : 0;
                                      
                                      let drivmiddelMonthly = 0;
                                      if (car.drivmiddel === 'El') {
                                          drivmiddelMonthly = parameters.opladningsAbonnement || 0;
                                      } else if (car.drivmiddel === 'Benzin' && car.kmPerLiter > 0) {
                                          const kmPerMonth = (parameters.kmPerAar || 0) / 12;
                                          drivmiddelMonthly = (kmPerMonth / car.kmPerLiter) * (parameters.benzinPris || 0);
                                      }

                                      const driftsudgifter = (car.forsikring || 0) + (car.service || 0) + gronAfgiftMonthly + daekMonthly + (car.uforudseteReparationer || 0) + synMonthly + drivmiddelMonthly;
                                      const totalDrift96mdr = driftsudgifter * 96;
                                      const kerneYdelse = car.type === 'Køb' ? car.finansieringYdelse : car.leasingYdelse;
                                      const totalPerMaaned = kerneYdelse + driftsudgifter;
                                      
                                      let totalBiludgift96mdr = 0;
                                      let restvaerdi = 0;

                                      if (car.type === 'Køb') {
                                          totalBiludgift96mdr = (car.finansieringYdelse * (car.laaneTid || 0)) + (car.udbetaling || 0);
                                          restvaerdi = (car.pris || 0) * (1 - ((car.vaerditabProcent || 100) / 100));
                                      } else { // Leasing
                                          const leasingPeriode = car.leasingPeriode || 36;
                                          const antalKontrakter = Math.ceil(96 / leasingPeriode);
                                          const totalUdbetalinger = (car.udbetaling || 0) * antalKontrakter;
                                          totalBiludgift96mdr = (kerneYdelse * 96) + totalUdbetalinger;
                                      }
                                      const totalOmkostning96mdr = totalBiludgift96mdr + totalDrift96mdr;
                                      const nettoOmkostning = totalOmkostning96mdr - restvaerdi;
                                      
                                      let rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                                      if (car.isFavorite) {
                                          rowClass = 'bg-green-100';
                                      }
                                      const drivmiddelColorClass = car.drivmiddel === 'El' ? 'bg-blue-50' : 'bg-orange-50';

                                      return (
                                          <tr key={`summary-${car.id}`} className={rowClass}>
                                              <td className={`px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 ${drivmiddelColorClass}`}>
                                                <button onClick={() => handleToggleFavorite(car.id)} className="flex items-center space-x-2 hover:underline">
                                                    <svg className={`w-4 h-4 ${car.isFavorite ? 'text-yellow-400' : 'text-gray-300'}`} fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                                    <span>{car.name}</span>
                                                </button>
                                              </td>
                                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{car.type}</td>
                                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{car.drivmiddel}</td>
                                              <td className="px-6 py-4 whitespace-nowrap text-sm text-purple-800 font-semibold">{formatCurrency(totalPerMaaned)}</td>
                                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{formatCurrency(totalBiludgift96mdr)}</td>
                                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{formatCurrency(totalDrift96mdr)}</td>
                                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-semibold">{formatCurrency(totalOmkostning96mdr)}</td>
                                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{formatCurrency(restvaerdi)}</td>
                                              <td className="px-6 py-4 whitespace-nowrap text-sm text-purple-800 font-bold">{formatCurrency(nettoOmkostning)}</td>
                                          </tr>
                                      );
                                  })}
                              </tbody>
                          </table>
                          <p className="text-xs text-gray-500 mt-2 p-2">
                              *Netto Omkostning viser den reelle udgift over 8 år, når en eventuel restværdi ved salg er trukket fra. For leasingbiler antages det, at en tilsvarende aftale fornys, og en ny førstegangsydelse er medregnet for hver ny kontraktperiode.
                          </p>
                      </div>
                  </div>
              );
          };
          
          if (isLoading) {
              return (
                  <div className="flex items-center justify-center h-screen">
                      <div className="spinner"></div>
                  </div>
              );
          }

          return (
            <div className="font-sans">
                {errorModalVisible && (
                  <div className="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full z-50 flex items-center justify-center">
                    <div className="p-5 border w-96 shadow-lg rounded-md bg-white text-center">
                        <h3 className="text-lg font-medium text-gray-900">Fejl</h3>
                        <p className="text-sm text-gray-500 mt-2">Indtast venligst et navn til den nye bil.</p>
                        <div className="mt-4"><button onClick={() => setErrorModalVisible(false)} className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-700">OK</button></div>
                    </div>
                  </div>
                )}
                {confirmModalState.isOpen && (
                  <div className="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full z-50 flex items-center justify-center">
                    <div className="p-5 border w-96 shadow-lg rounded-md bg-white text-center">
                        <h3 className="text-lg font-medium text-gray-900">Bekræft sletning</h3>
                        <p className="text-sm text-gray-500 mt-2">Er du sikker på, at du vil fjerne "{confirmModalState.carName}"?</p>
                        <div className="mt-4">
                            <button onClick={handleConfirmRemove} className="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-700">Ja, fjern</button>
                            <button onClick={closeRemoveModal} className="px-4 py-2 bg-gray-200 rounded-md ml-2 hover:bg-gray-300">Annuller</button>
                        </div>
                    </div>
                  </div>
                )}

                <div className="w-full max-w-screen-2xl mx-auto p-4">
                  <header className="flex items-center justify-center relative mb-6 py-4 sticky top-0 z-20 bg-gray-50 no-print">
                      <div className="absolute left-0">
                          <button onClick={() => setIsSidebarVisible(!isSidebarVisible)} className="flex items-center space-x-2 bg-white p-2 rounded-lg shadow hover:bg-gray-100 border text-sm">
                              <svg className={`w-5 h-5 transition-transform duration-300 ${isSidebarVisible ? '' : 'rotate-180'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7"></path></svg>
                              <span className="hidden sm:inline">{isSidebarVisible ? 'Skjul' : 'Vis'} Parametre</span>
                          </button>
                      </div>
                      <div className="text-center px-16">
                          <h1 className="text-2xl sm:text-3xl font-bold text-gray-800">Dynamisk Bilbudget Beregner</h1>
                          <p className="text-sm sm:text-base text-gray-600">Sammenlign el-, benzin-, leasing- og køb af biler</p>
                      </div>
                  </header>
                  
                  <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    {isSidebarVisible && (
                        <div className="lg:col-span-1 bg-white p-3 rounded-lg shadow-md h-fit lg:sticky top-28 no-print">
                          <div className="mb-4">
                            <h3 className="text-base font-semibold mb-2 border-b pb-1">Globale Parametre</h3>
                            <div className="space-y-2">
                              <div className="grid grid-cols-5 items-center gap-2">
                                <label className="text-xs font-medium col-span-3">Sammenligningsperiode (mdr.)</label>
                                <input type="number" name="periode" value={parameters.periode} onChange={handleParamChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                              </div>
                              <div className="p-2 rounded-lg bg-blue-50 border border-blue-200">
                                   <div className="grid grid-cols-5 items-center gap-2">
                                      <div className="col-span-3">
                                          <label className="text-xs font-medium text-blue-800">For Elbiler</label>
                                          <p className="text-xs font-medium text-gray-800">(fri elaftale med Clever One)</p>
                                      </div>
                                      <input type="number" name="opladningsAbonnement" value={parameters.opladningsAbonnement} onChange={handleParamChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                   </div>
                              </div>
                              <div className="p-2 rounded-lg bg-orange-50 border border-orange-200 space-y-2">
                                   <label className="text-xs font-medium text-orange-800 col-span-3">For Benzinbiler</label>
                                   <div className="grid grid-cols-5 items-center gap-2">
                                      <label className="text-xs font-medium col-span-3">Årligt kørselsbehov (km)</label>
                                      <input type="number" name="kmPerAar" value={parameters.kmPerAar} onChange={handleParamChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                   </div>
                                   <div className="grid grid-cols-5 items-center gap-2">
                                      <label className="text-xs font-medium col-span-3">Benzinpris (kr./l)</label>
                                      <input type="number" name="benzinPris" value={parameters.benzinPris} onChange={handleParamChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                   </div>
                              </div>
                            </div>
                          </div>
                          
                          <div className="mb-4">
                              <h3 className="text-base font-semibold mb-2 border-b pb-1">Gem & Hent Scenarier</h3>
                              <div className="space-y-2">
                                  <input type="text" value={saveName} onChange={(e) => setSaveName(e.target.value)} placeholder="Navn på scenarie..." className="w-full p-1 border rounded-md text-sm"/>
                                  <button onClick={saveData} className="w-full bg-blue-600 text-white px-2 py-1 rounded-md hover:bg-blue-700 text-sm transition-colors">Gem som...</button>
                                  <select value={selectedScenario} onChange={(e) => { setSelectedScenario(e.target.value); }} className="w-full p-1 mt-1 border rounded-md bg-white text-sm">
                                      <option value="">Vælg et gemt scenarie</option>
                                      {savedScenarios.map(scenario => <option key={scenario.id} value={scenario.id}>{scenario.id}</option>)}
                                  </select>
                                  <div className="flex space-x-2">
                                      <button onClick={loadData} className="flex-1 bg-gray-200 text-gray-800 px-2 py-1 rounded-md hover:bg-gray-300 text-sm transition-colors">Hent valgte</button>
                                      <button onClick={deleteData} className="flex-1 bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-700 text-sm transition-colors">Slet valgte</button>
                                  </div>
                              </div>
                              {saveMessage && <p className="text-xs text-center mt-2 text-gray-600">{saveMessage}</p>}
                          </div>
                          
                          <div>
                            <h3 className="text-base font-semibold mb-2 border-b pb-1">Tilføj Ny Bil</h3>
                            <div className="space-y-1.5">
                                <div className="grid grid-cols-3 items-center gap-2">
                                    <label className="text-xs font-medium">Navn</label>
                                    <input type="text" name="name" value={newCar.name} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                </div>
                                <div className="grid grid-cols-5 items-center gap-2">
                                    <label className="text-xs font-medium col-span-3">Type</label>
                                    <select name="type" value={newCar.type} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md bg-white text-sm">
                                        <option value="Leasing">Leasing</option>
                                        <option value="Køb">Køb</option>
                                    </select>
                                </div>
                                 <div className="grid grid-cols-5 items-center gap-2">
                                    <label className="text-xs font-medium col-span-3">Drivmiddel</label>
                                    <select name="drivmiddel" value={newCar.drivmiddel} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md bg-white text-sm">
                                        <option value="El">El</option>
                                        <option value="Benzin">Benzin</option>
                                    </select>
                                </div>
                              
                              {newCar.type === 'Leasing' && (
                                  <div className="bg-green-50 p-2 rounded-lg space-y-1.5 border border-green-200">
                                      <h4 className="font-semibold text-green-800 text-sm col-span-3">Leasing Detaljer</h4>
                                      <div className="grid grid-cols-5 items-center gap-2">
                                        <label className="text-xs font-medium col-span-3">Nypris</label>
                                        <input type="number" name="nypris" value={newCar.nypris} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                      </div>
                                      <div className="grid grid-cols-5 items-center gap-2">
                                        <label className="text-xs font-medium col-span-3">Leasingydelse/md</label>
                                        <input type="number" name="leasingYdelse" value={newCar.leasingYdelse} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                      </div>
                                      <div className="grid grid-cols-5 items-center gap-2">
                                        <label className="text-xs font-medium col-span-3">Leasingperiode</label>
                                        <input type="number" name="leasingPeriode" value={newCar.leasingPeriode} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                      </div>
                                  </div>
                              )}
                              
                              {newCar.type === 'Køb' && (
                                  <div className="bg-blue-50 p-2 rounded-lg space-y-1.5 border border-blue-200">
                                      <h4 className="font-semibold text-blue-800 text-sm col-span-3">Finansieringsdetaljer</h4>
                                      <div className="grid grid-cols-5 items-center gap-2">
                                        <label className="text-xs font-medium col-span-3">Kontantpris</label>
                                        <input type="number" name="pris" value={newCar.pris} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                      </div>
                                      <div className="grid grid-cols-5 items-center gap-2">
                                        <label className="text-xs font-medium col-span-3">Månedlig Ydelse</label>
                                        <input type="number" name="finansieringYdelse" value={newCar.finansieringYdelse} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                      </div>
                                      <div className="grid grid-cols-5 items-center gap-2">
                                        <label className="text-xs font-medium col-span-3">Løbetid (mdr.)</label>
                                        <input type="number" name="laaneTid" value={newCar.laaneTid} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                      </div>
                                      <div className="grid grid-cols-5 items-center gap-2">
                                        <label className="text-xs font-medium col-span-3">Værditab 8 år (%)</label>
                                        <input type="number" name="vaerditabProcent" value={newCar.vaerditabProcent} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                      </div>
                                  </div>
                              )}

                              <div className="space-y-1.5 pt-2 border-t">
                                  <h4 className="font-semibold text-gray-700 text-sm col-span-3">Fælles Detaljer</h4>
                                  {newCar.drivmiddel === 'Benzin' && (
                                    <div className="grid grid-cols-5 items-center gap-2">
                                        <label className="text-xs font-medium col-span-3">Km/l</label>
                                        <input type="number" name="kmPerLiter" value={newCar.kmPerLiter} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                    </div>
                                  )}
                                  <div className="grid grid-cols-5 items-center gap-2">
                                    <label className="text-xs font-medium col-span-3">Udbetaling</label>
                                    <input type="number" name="udbetaling" value={newCar.udbetaling} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                  </div>
                                  <div className="grid grid-cols-5 items-center gap-2">
                                    <label className="text-xs font-medium col-span-3">Forsikring/md</label>
                                    <input type="number" name="forsikring" value={newCar.forsikring} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                  </div>
                                  <div className="grid grid-cols-5 items-center gap-2">
                                    <label className="text-xs font-medium col-span-3">Service/md</label>
                                    <input type="number" name="service" value={newCar.service} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                  </div>
                                  {newCar.type === 'Køb' && (
                                    <>
                                      <div className="grid grid-cols-5 items-center gap-2">
                                          <label className="text-xs font-medium col-span-3">Syn (hvert 2. år)</label>
                                          <input type="number" name="synsPris" value={newCar.synsPris} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                      </div>
                                      <div className="grid grid-cols-5 items-center gap-2">
                                          <label className="text-xs font-medium col-span-3">Uforudsete Rep.</label>
                                          <input type="number" name="uforudseteReparationer" value={newCar.uforudseteReparationer} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                      </div>
                                    </>
                                  )}
                                  <div className="grid grid-cols-5 items-center gap-2">
                                    <label className="text-xs font-medium col-span-3">Grøn afgift (½år)</label>
                                    <input type="number" name="gronAfgiftHalvaar" value={newCar.gronAfgiftHalvaar} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                  </div>
                                  <div className="bg-gray-50 p-2 rounded-lg border">
                                      <h5 className="font-semibold text-xs text-gray-500 mb-1">Periodiske Udgifter (Dæk)</h5>
                                      <div className="grid grid-cols-5 items-center gap-2 mt-1">
                                        <label className="text-xs font-medium col-span-3">Pris (4 stk.)</label>
                                        <input type="number" name="daekPrisTotal" value={newCar.daekPrisTotal} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                      </div>
                                      <div className="grid grid-cols-5 items-center gap-2 mt-1">
                                        <label className="text-xs font-medium col-span-3">Levetid (mdr.)</label>
                                        <input type="number" name="daekLevetidMdr" value={newCar.daekLevetidMdr} onChange={handleNewCarChange} className="col-span-2 w-full p-1 border rounded-md text-sm" />
                                      </div>
                                  </div>
                              </div>
                              <button onClick={addCar} className="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition-colors mt-3">Tilføj bil</button>
                            </div>
                          </div>
                        </div>
                    )}

                    <div className={isSidebarVisible ? "lg:col-span-3" : "lg:col-span-4"}>
                        <div className="space-y-8">
                          {kobeBiler.length > 0 && (
                            <div>
                              <div className="flex items-center text-2xl font-bold text-gray-700 mb-3 p-3 bg-gray-100 rounded-t-lg border-b-2 border-blue-500">
                                <button onClick={() => setIsKøbVisible(!isKøbVisible)} className="mr-3 p-1 rounded-full hover:bg-gray-200">
                                    <svg className={`w-6 h-6 transition-transform duration-200 ${isKøbVisible ? '' : '-rotate-90'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <h2>Køb af Bil</h2>
                              </div>
                              {isKøbVisible && (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                                  {kobeBiler.map((car, index) => renderCarColumn(car, index, kobeBiler))}
                                </div>
                              )}
                            </div>
                          )}
                          {leasingBiler.length > 0 && (
                            <div>
                               <div className="flex items-center text-2xl font-bold text-gray-700 mb-3 p-3 bg-gray-100 rounded-t-lg border-b-2 border-green-500">
                                <button onClick={() => setIsLeasingVisible(!isLeasingVisible)} className="mr-3 p-1 rounded-full hover:bg-gray-200">
                                    <svg className={`w-6 h-6 transition-transform duration-200 ${isLeasingVisible ? '' : '-rotate-90'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <h2>Privatleasing</h2>
                              </div>
                              {isLeasingVisible && (
                               <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                                {leasingBiler.map((car, index) => renderCarColumn(car, index, leasingBiler))}
                              </div>
                              )}
                            </div>
                          )}
                          
                          {/* Long Term Summary Section */}
                          <div className="mt-8">
                              <LongTermSummary />
                          </div>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
          );
        }
        
        // Lyt efter 'firebaseReady' eventet før React-appen startes
        document.addEventListener('firebaseReady', () => {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        });
    </script>
</body>
</html>
